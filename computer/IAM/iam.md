# 使用keycloak服务授权
## 授权中的术语与概念
### Resource Server / 资源服务
存储受保护资源的服务，能够接受对这些受保护资源的请求并响应。
这些服务需要一类信息，用于判断是否接受对受保护资源的访问。基于RESTFul的资源服务通常通过bearer令牌携带这类信息，web应用则通常把信息存储在session中。
在keycloak中，*confidential*类型的注册服务(`client application`)都可以作为资源服务。这些注册服务以及他们自己的资源都通过一系列的授权策略保护。

### Resource / 资源
资源是应用或组织的资产的一部分。资源可以是端点，一类网络资源，比如HTML页面等等。在授权策略中，所有的资源都被抽象成对象。
资源对象可以指代单一的资源或一组资源。比如我们既可以把所有的银行账户定义成一种资源，并给这种资源设置一组统一的授权策略；也可以把小李的账户设置为另一种资源，这种资源独属于一位用户，并给这种资源设置一组独立的授权策略。

### Scope / 作用域
资源的作用域是指对资源执可能执行的的操作。比如`view`、`edit`、`delete`等。

### Permission / 权限
权限通过一组策略和受保护资源相关联，策略定义了对资源的访问是否可以通过。

### Policy / 策略
策略定义了访问一种对象时必须满足的条件。定义策略时不需要指定对象，只需要定义访问对象时要满足的条件。
通过策略，我们可以实现基于属性的访问机制、基于角色的访问机制或基于上下文的访问机制以及其他授权机制。
keycloak中策略和聚合策略的概念，是我们可以定义策略组的策略，通过分治技术，定义一组独立的策略，再把他们复用于不同的权限，这样可以通过组合不同的策略构造更复杂的策略。

### Policy Provider / 策略提供程序
策略提供程序是指特定策略类型的实现。Keycloak提供了服务接口，我们可以使用该接口添加自定义的策略提供程序。

### Permission Ticket / 权限票据
权限票据是一种token，在UMA(User-Managed Access / 用户管理授权)规范中定义。权限票据提供一种不透明的数据结构，其中包含了客户端请求的资源和作用域、请求上下文以及必须应用于请求的策略。
权限票据在用户向用户分享资源或用户向组织分享资源时非常重要。
在UMA流程中，授权服务发布授权票据给资源服务，资源服务把授权票据发给尝试访问受保护资源的客户端，客户端收到票据后把票据发给授权服务请求RPT（请求方令牌）。

## 资源服务管理
### 资源服务设置项
#### 策略执行模式
* Enforcing
默认的执行模式，如果请求的资源没有关联的策略，则拒绝请求。
* Permissive
如果请求的资源没有相关联策略，则接受请求。
* Disable
取消所有的策略匹配，允许访问所有的资源。

#### 鉴权策略
授权策略评估引擎会根据鉴权策略对所有的权限评估，并根据所有的评估结果决定是否授予对请求资源和作用域的访问。
* Affirmative
只要任一权限满足则接受访问
* Unanimous
所有的权限都满足才可以接受访问

#### 远程资源管理
如果设置为false，则只能通过管理控制台设置资源

### 默认配置
keycloak会在用户创建资源服务时，创建默认授权配置，这些配置包括：
* 一条默认的受保护资源，这条资源代表应用中的全部资源
* 一条策略，使用这条策略会授予所有相关资源访问权限
* 一条权限，这条权限把默认策略和所有资源相关联

默认资源的类型定义为`urn:{clientID}:resources:default`，URI定义为`/*`。这个URI使用通配符，代表应用的所有路径。所以允许鉴权时，所有的访问都必须经过鉴权。在创建和默认资源相关的权限时需要使用类型值。

## 资源与作用域管理
### 类型/ Type
type是一条唯一的字符串，代表一种或多种资源。使用type可以把资源分组，并次啊用相同的策略保护这些资源。

### 资源拥有者
默认情况下，资源的拥有者是应用，但是也可以设置为用户，这样可以指定基于用户的策略，
比如，只有用户可以删除或更新指定的资源。

### 远程资源管理
资源服务可以通过API远程管理资源

## 管理策略