# 使用keycloak服务授权
## 授权中的术语与概念
### Resource Server / 资源服务
存储受保护资源的服务，能够接受对这些受保护资源的请求并响应。
这些服务需要一类信息，用于判断是否接受对受保护资源的访问。基于RESTFul的资源服务通常通过bearer令牌携带这类信息，web应用则通常把信息存储在session中。
在keycloak中，*confidential*类型的注册服务(`client application`)都可以作为资源服务。这些注册服务以及他们自己的资源都通过一系列的授权策略保护。

### Resource / 资源
资源是应用或组织的资产的一部分。资源可以是端点，一类网络资源，比如HTML页面等等。在授权策略中，所有的资源都被抽象成对象。
资源对象可以指代单一的资源或一组资源。比如我们既可以把所有的银行账户定义成一种资源，并给这种资源设置一组统一的授权策略；也可以把小李的账户设置为另一种资源，这种资源独属于一位用户，并给这种资源设置一组独立的授权策略。

### Scope / 作用域
资源的作用域是指对资源执可能执行的的操作。比如`view`、`edit`、`delete`等。

### Permission / 权限
权限通过一组策略和受保护资源相关联，策略定义了对资源的访问是否可以通过。

### Policy / 策略
策略定义了访问一种对象时必须满足的条件。定义策略时不需要指定对象，只需要定义访问对象时要满足的条件。
通过策略，我们可以实现基于属性的访问机制、基于角色的访问机制或基于上下文的访问机制以及其他授权机制。
keycloak中策略和聚合策略的概念，是我们可以定义策略组的策略，通过分治技术，定义一组独立的策略，再把他们复用于不同的权限，这样可以通过组合不同的策略构造更复杂的策略。

### Policy Provider / 策略提供程序
策略提供程序是指特定策略类型的实现。Keycloak提供了服务接口，我们可以使用该接口添加自定义的策略提供程序。

### Permission Ticket / 权限票据
权限票据是一种token，在UMA(User-Managed Access / 用户管理授权)规范中定义。权限票据提供一种不透明的数据结构，其中包含了客户端请求的资源和作用域、请求上下文以及必须应用于请求的策略。
权限票据在用户向用户分享资源或用户向组织分享资源时非常重要。
在UMA流程中，授权服务发布授权票据给资源服务，资源服务把授权票据发给尝试访问受保护资源的客户端，客户端收到票据后把票据发给授权服务请求RPT（请求方令牌）。

## 资源服务管理
### 资源服务设置项
#### 策略执行模式
* Enforcing
默认的执行模式，如果请求的资源没有关联的策略，则拒绝请求。
* Permissive
如果请求的资源没有相关联策略，则接受请求。
* Disable
取消所有的策略匹配，允许访问所有的资源。

#### 授权模式
授权策略评估引擎会根据授权模式对所有的权限评估，并根据所有的评估结果决定是否授予对请求资源和作用域的访问。
* Affirmative
只要任一权限满足则接受访问
* Unanimous
所有的权限都满足才可以接受访问

#### 远程资源管理
如果设置为false，则只能通过管理控制台设置资源

### 默认配置
keycloak会在用户创建资源服务时，创建默认授权配置，这些配置包括：
* 一条默认的受保护资源，这条资源代表应用中的全部资源
* 一条策略，使用这条策略会授予所有相关资源访问权限
* 一条权限，这条权限把默认策略和所有资源相关联

默认资源的类型定义为`urn:{clientID}:resources:default`，URI定义为`/*`。这个URI使用通配符，代表应用的所有路径。所以允许鉴权时，所有的访问都必须经过鉴权。在创建和默认资源相关的权限时需要使用类型值。

## 资源与作用域管理
### 类型/ Type
type是一条唯一的字符串，代表一种或多种资源。使用type可以把资源分组，并次啊用相同的策略保护这些资源。

### 资源拥有者
默认情况下，资源的拥有者是应用，但是也可以设置为用户，这样可以指定基于用户的策略，
比如，只有用户可以删除或更新指定的资源。

### 远程资源管理
资源服务可以通过API远程管理资源

## 管理策略
### 基于用户的策略
此策略用于一组用户可以访问某对象的情况。
#### 配置
* 名称
* 描述
* 用户，指定可以使用此策略授权的用户
* 逻辑，授权或拒绝

### 基于角色的策略
此策略用于一组用户可以访问某对象的情况。默认情况下，添加到策略中的角色不是必须全部满足的，如用用户满足其中任一角色，即可授予权限。但是可以设置某些角色为必须满足的。
在需要严格的基于角色授权的场景下，基于角色策略很有用，这时必须满足指定的角色才能访问特定的资源。比如，你可以强制要求用户必须同意客户端应用访问他们的资源。
#### 配置
* 名称
* 描述
* 域角色
* 应用角色，使用应用角色前必须先选择角色
* 授权逻辑

#### 必须角色
如果指定了必须角色，那么只有用户的角色满足所有的必须角色时，请求才会被授权。

### 基于JS的角色

### 基于时间的角色
#### 配置
* 名称
* 描述
* Not Before
在这个字段定义的时间之前访问不会被授权
* Not On of After
在这个字段定义的时间之后，访问不会被授权
* Day of Month
* Month
* Year
* Hour
* Minute
* Logic

只有所有的条件都满足时，请求才会被授权。

### 聚合策略
keycloak中可以定义策略的策略，即把策略聚合使用，这样可以服用定义好的策略创造更复杂的策略，实现权限和策略的解耦。
在创建聚合策略时需要选择授权模式。除了上文的`Unanimous`、`Affirmative`外，还包括`Consensus`，当通过的策略数高于未通过的策略数时，授予权限。

### 基于客户应用的策略
允许一组客户端访问对象。
#### 配置
* 名称
* 描述
* 客户应用
* 逻辑

### 基于群组的策略
决定是否对某一群组的用户授权。
#### 配置
* 名称
* 描述
* 群组申明： 通常授权是基于令牌，通过此配置项指定令牌中的哪一字段包含群组名称。
* 群组
* 逻辑

#### 向子群组拓展访问权限
默认情况下，权限仅对严格属于选定的群组有效。但是可以延申给子群组。

### 应用作用域策略

### 基于正则表达式的授权策略

## 权限管理
权限把受保护的资源和必须满足的策略关联起来。
权限可以保护两种对象：
* 资源
* 作用域

### 基于资源的权限
基于资源的权限使用一组授权策略保护一组选定的资源。
#### 配置
* 名称
* 描述
* 应用的资源类型，定义这个字段后，所有匹配这一类型的资源都被保护
* 资源
* 应用策略
* 决策模式
  * Unanimous: 必须所有的策略都满足才授权
  * Affirmative：任一策略满足即授权
  * Consensus: 满足授权的策略数量大于不满足授权的策略数量就授权
#### 分类资源权限
资源权限可以应用给有相同类型的资源。应用中的资源可以根据他们涉及的数据或提供的功能分类。比如财务应用可以管理不同的账户，每个账户都属于特定的用户。这些不同的账户都有相同的安全需求。使用分类资源权限可以仅让账户拥有者可以管理账户；只允许账户拥有着访问账户；实行特定的认证方法。

### 基于作用域的权限
基于资源的权限使用一组授权策略保护一组选定的作用域。使用基于作用域的权限，既可以选择资源也可以选择作用域。
#### 配置
* 名称
* 描述
* 资源
* 作用域
* 应用策略
* 决策模式
  * Unanimous: 必须所有的策略都满足才授权
  * Affirmative：任一策略满足即授权
  * Consensus: 满足授权的策略数量大于不满足授权的策略数量就授

## 服务鉴权
Keycloak的鉴权服务基于OAuth2和UMA规范。
OAuth2客户端，比如前端应用，通过token端点从服务获取访问令牌，再使用访问令牌向资源服务，比如后端服务，获取资源。Keycloak以同样的流程拓展了OAuth2，根据被请求的资源和作用域找出相关联的的策略，再根据策略的授权评估结果发布访问令牌。资源服务器可以基于服务授予的权限和令牌中包含的权限决定是否接受对资源的访问。
在Keycloak中，携带权限的访问令牌称为请求方令牌，简称为RPT。
除了发布RPT，KeyCloak授权服务还提供了一组RESTful端点，允许资源服务器管理其受保护的资源、作用域、权限和策略，帮助开发人员将这些功能扩展或集成到其应用程序中，以支持细粒度授权。

### 授权服务端点与元信息发现
客户端可以通过Keycloak提供的发现端点，获取和Keycloak授权服务交互需要的所有必要信息，包括端点地址以及功能。
发现文档可以通过：
```bash
curl -X GET http://${host}:${port}/realms/${realm}/.well-known/uma2-configuration
```
可以收到如下响应：
```json
{
    // some claims are expected here

    // these are the main claims in the discovery document about Authorization Services endpoints location
    "token_endpoint": "http://${host}:${port}/realms/${realm}/protocol/openid-connect/token",
    "token_introspection_endpoint": "http://${host}:${port}/realms/${realm}/protocol/openid-connect/token/introspect",
    "resource_registration_endpoint": "http://${host}:${port}/realms/${realm}/authz/protection/resource_set",
    "permission_endpoint": "http://${host}:${port}/realms/${realm}/authz/protection/permission",
    "policy_endpoint": "http://${host}:${port}/realms/${realm}/authz/protection/uma-policy"
}
```
不同的端点提供不同的功能
* token_endpoint: 符合OAuth2的令牌端点，支持`urn:ietf:params:oauth:grant-type:uma`票证授予类型。通过这个端点，客户端可以发送授权请求，并获得一个RPT，该RPT包含Keycloak授予的所有权限。
* token_introspection_endpoint: 符合OAuth2的令牌检查端点，客户端可以使用该端点检查服务器，以确定RPT的活动状态，并确定与令牌相关的任何其他信息，例如KeyCloak授予的权限。
* resource_registration_endpoint: 符合UMA的资源注册端点，资源服务器可以通过这个端点管理资源和作用域。包括创建、查询、更新和删除。
* permission_endpoint: 符合UMA的权限端点，资源服务器可以通过此端点管理授权票据。此端点提供权限的创建、查询、更新和删除操作。